{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/yerkomunoz/Dev-personal/V0/v0-gym-attendance-app/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient as createSupabaseServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\n\nexport async function createClient() {\n  const cookieStore = await cookies();\n\n  return createSupabaseServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options),\n            );\n          } catch {\n            // The \"setAll\" method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    },\n  );\n}\n\nexport async function createServerClient() {\n  const cookieStore = await cookies();\n\n  return createSupabaseServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options),\n            );\n          } catch {\n            // The \"setAll\" method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    },\n  );\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,2SAAO;IAEjC,OAAO,IAAA,4SAA0B,sUAG/B;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,2SAAO;IAEjC,OAAO,IAAA,4SAA0B,sUAG/B;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 99, "column": 0}, "map": {"version":3,"sources":["file:///Users/yerkomunoz/Dev-personal/V0/v0-gym-attendance-app/proxy.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\n\n// Routes that don't require authentication\nconst publicRoutes = ['/login'];\n\n// Routes that require specific roles\nconst roleRoutes = {\n    admin: ['/admin', '/branches', '/plans'],\n    trainer: ['/trainers', '/students', '/history'],\n    student: ['/student'],\n};\n\nexport async function proxy(request: NextRequest) {\n    const { pathname } = request.nextUrl;\n\n    // Allow public routes\n    if (publicRoutes.some(route => pathname.startsWith(route))) {\n        return NextResponse.next();\n    }\n\n    // Allow static files and API routes\n    if (\n        pathname.startsWith('/_next') ||\n        pathname.startsWith('/api') ||\n        pathname.startsWith('/static') ||\n        pathname.includes('.')\n    ) {\n        return NextResponse.next();\n    }\n\n    try {\n        const supabase = await createClient();\n\n        // Use getUser() instead of getSession() for server-side authentication\n        // This validates the session with Supabase Auth server\n        const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n        // Redirect to login if not authenticated\n        if (authError || !user) {\n            const loginUrl = new URL('/login', request.url);\n            loginUrl.searchParams.set('redirect', pathname);\n            return NextResponse.redirect(loginUrl);\n        }\n\n        // Get user profile with role\n        const { data: userProfile } = await supabase\n            .from('users')\n            .select('role, active')\n            .eq('id', user.id)\n            .single();\n\n        console.log('ðŸ” User check:', {\n            userId: user.id,\n            email: user.email,\n            userFound: !!userProfile,\n            active: userProfile?.active,\n            role: userProfile?.role\n        });\n\n        // Check if user is active\n        if (!userProfile || !userProfile.active) {\n            console.error('âŒ User is inactive or not found:', {\n                userExists: !!userProfile,\n                active: userProfile?.active\n            });\n            const loginUrl = new URL('/login', request.url);\n            loginUrl.searchParams.set('error', 'inactive');\n            return NextResponse.redirect(loginUrl);\n        }\n\n        // Check role-based access\n        const userRole = userProfile.role as 'admin' | 'trainer' | 'student';\n\n        // Admin has access to everything\n        if (userRole === 'admin') {\n            return NextResponse.next();\n        }\n\n        // Check if the route requires a specific role\n        for (const [requiredRole, routes] of Object.entries(roleRoutes)) {\n            if (routes.some(route => pathname.startsWith(route))) {\n                // If user doesn't have the required role, redirect\n                if (userRole !== requiredRole) {\n                    // Redirect to appropriate dashboard based on user's role\n                    const dashboardUrl = new URL('/', request.url);\n                    return NextResponse.redirect(dashboardUrl);\n                }\n            }\n        }\n\n        return NextResponse.next();\n    } catch (error) {\n        console.error('Middleware error:', error);\n        // On error, redirect to login\n        const loginUrl = new URL('/login', request.url);\n        return NextResponse.redirect(loginUrl);\n    }\n}\n\nexport const config = {\n    matcher: [\n        /*\n         * Match all request paths except:\n         * - _next/static (static files)\n         * - _next/image (image optimization files)\n         * - favicon.ico (favicon file)\n         * - public files (public directory)\n         */\n        '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n    ],\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;;;AAEA,2CAA2C;AAC3C,MAAM,eAAe;IAAC;CAAS;AAE/B,qCAAqC;AACrC,MAAM,aAAa;IACf,OAAO;QAAC;QAAU;QAAa;KAAS;IACxC,SAAS;QAAC;QAAa;QAAa;KAAW;IAC/C,SAAS;QAAC;KAAW;AACzB;AAEO,eAAe,MAAM,OAAoB;IAC5C,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,sBAAsB;IACtB,IAAI,aAAa,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC,SAAS;QACxD,OAAO,+SAAY,CAAC,IAAI;IAC5B;IAEA,oCAAoC;IACpC,IACI,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,WACpB,SAAS,UAAU,CAAC,cACpB,SAAS,QAAQ,CAAC,MACpB;QACE,OAAO,+SAAY,CAAC,IAAI;IAC5B;IAEA,IAAI;QACA,MAAM,WAAW,MAAM,IAAA,yIAAY;QAEnC,uEAAuE;QACvE,uDAAuD;QACvD,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAExE,yCAAyC;QACzC,IAAI,aAAa,CAAC,MAAM;YACpB,MAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,GAAG;YAC9C,SAAS,YAAY,CAAC,GAAG,CAAC,YAAY;YACtC,OAAO,+SAAY,CAAC,QAAQ,CAAC;QACjC;QAEA,6BAA6B;QAC7B,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,SACL,MAAM,CAAC,gBACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;QAEX,QAAQ,GAAG,CAAC,kBAAkB;YAC1B,QAAQ,KAAK,EAAE;YACf,OAAO,KAAK,KAAK;YACjB,WAAW,CAAC,CAAC;YACb,QAAQ,aAAa;YACrB,MAAM,aAAa;QACvB;QAEA,0BAA0B;QAC1B,IAAI,CAAC,eAAe,CAAC,YAAY,MAAM,EAAE;YACrC,QAAQ,KAAK,CAAC,oCAAoC;gBAC9C,YAAY,CAAC,CAAC;gBACd,QAAQ,aAAa;YACzB;YACA,MAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,GAAG;YAC9C,SAAS,YAAY,CAAC,GAAG,CAAC,SAAS;YACnC,OAAO,+SAAY,CAAC,QAAQ,CAAC;QACjC;QAEA,0BAA0B;QAC1B,MAAM,WAAW,YAAY,IAAI;QAEjC,iCAAiC;QACjC,IAAI,aAAa,SAAS;YACtB,OAAO,+SAAY,CAAC,IAAI;QAC5B;QAEA,8CAA8C;QAC9C,KAAK,MAAM,CAAC,cAAc,OAAO,IAAI,OAAO,OAAO,CAAC,YAAa;YAC7D,IAAI,OAAO,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC,SAAS;gBAClD,mDAAmD;gBACnD,IAAI,aAAa,cAAc;oBAC3B,yDAAyD;oBACzD,MAAM,eAAe,IAAI,IAAI,KAAK,QAAQ,GAAG;oBAC7C,OAAO,+SAAY,CAAC,QAAQ,CAAC;gBACjC;YACJ;QACJ;QAEA,OAAO,+SAAY,CAAC,IAAI;IAC5B,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,qBAAqB;QACnC,8BAA8B;QAC9B,MAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,GAAG;QAC9C,OAAO,+SAAY,CAAC,QAAQ,CAAC;IACjC;AACJ;AAEO,MAAM,SAAS;IAClB,SAAS;QACL;;;;;;SAMC,GACD;KACH;AACL"}}]
}